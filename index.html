<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset-Tracker</title>

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.grey-light_blue.min.css" />
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

    <style>
        /* general styling */
        #wrapper {
            min-width: 340px;
            max-width: 1000px;
            margin: auto;
            padding: 5vw 5vw;
            height: fit-content;
        }

        .layoutElement {
            margin-top: 30px;
            margin-bottom: 0px;
        }

        p {
            display: inline-block;
        }

        h1 {
            margin-bottom: 0px;
        }

        /* assetForm */
        #assetForm {
            display: inline-block;
            width: 100%;
            margin-bottom: 50px;
        }

        #assetForm-hidden {
            display: none;
        }

        #assetForm form {
            /* display: inline-block; */
            float: left;
        }

        #assetForm .mdl-textfield {
            width: 150px;
            margin-right: 20px;
            display: inline-block;
        }

        #assetForm .mdl-button {
            float: right;
            /* display: inline-block; */
        }

        #error {
            color: red;
            width: max-content;
        }

        /* assetFilters */
        #assetControls {
            display: inline;
        }

        #assetFilters {
            float: right;
        }

        /* assetList */
        #asset-list {
            margin-left: -10px;
            margin-right: -10px;
            display: block;
            height: fit-content;
        }

        /* assetCard */
        .demo-card-square.mdl-card {
            width: 320px;
            /* height: 320px; */
            height: 240px;
            float: left;
            margin: 10px;
        }

        .demo-card-square>.mdl-card__title {
            color: #fff;
        }

        .demo-card-square.Crypto>.mdl-card__title {
            background:
                linear-gradient(0deg, rgba(90, 90, 90, 0.5), rgba(90, 90, 90, 0.5)),
                url('images/crypto.jpg') bottom right 15% no-repeat #46B6AC;
        }

        .demo-card-square.Stocks>.mdl-card__title {
            background:
                linear-gradient(0deg, rgba(90, 90, 90, 0.5), rgba(90, 90, 90, 0.5)),
                url('images/stocks.jpg') bottom right 15% no-repeat #46B6AC;
        }

        .demo-card-square.Metals>.mdl-card__title {
            background:
                linear-gradient(0deg, rgba(90, 90, 90, 0.5), rgba(90, 90, 90, 0.5)),
                url('images/metal.jpg') bottom right 15% no-repeat #46B6AC;
        }

        .mdl-card__title-text {
            font-size: 30px;
            font-weight: 600;
        }

        .footer {
            display: block;
            width: 100%;
        }

        #total-value {
            font-size: 30px;
            font-weight: 600;
        }
    </style>

    <script>

        // let ASSETS = {}
        let ASSETS = {
            Bitcoin: {
                assetType: 'Crypto',
                assetName: 'Bitcoin',
                assetAbb: 'BTC',
                assetQuantity: 0.01288,
                assetUnit: 'Piece',
                assetBaseValue: 30000,
                assetValue: 1000,
                assetNotes: '',
            },
            Ethereum: {
                assetType: 'Crypto',
                assetName: 'Ethereum',
                assetAbb: 'ETH',
                assetQuantity: 0.029,
                assetUnit: 'Piece',
                assetBaseValue: 1000,
                assetValue: 1000,
                assetNotes: '',
            },
            Silver: {
                assetType: 'Metals',
                assetName: 'Silver',
                assetAbb: '',
                assetQuantity: 754,
                assetUnit: 'Oz',
                assetBaseValue: 20,
                assetValue: 1000,
                assetNotes: '',
            },
            Gold: {
                assetType: 'Metals',
                assetName: 'Gold',
                assetAbb: '',
                assetQuantity: 2.25,
                assetUnit: 'Oz',
                assetBaseValue: 1000,
                assetValue: 1000,
                assetNotes: '',
            },
        }

        let DELETED_ASSET = {}

        let totalValue

        const assetQuantityUnits = [
            { name: 'Stocks', unit: ' pieces' },
            { name: 'Metals', unit: ' Oz' },
            { name: 'Crypto', unit: ' pieces' },
        ];

        const assetCodes = {
            "ADA": "Cardano",
            "ALU": "Aluminum",
            "AAPL": "Apple",
            "ABEA": "Alphabet",
            "AMZ": "Amazon",
            "BCH": "Bitcoin Cash",
            "BTC": "Bitcoin",
            "ETH": "Ethereum",
            "IRD": "Iridium",
            "LCO": "Cobalt",
            "LINK": "Chainlink",
            "LTC": "Litecoin",
            "FB2A": "Meta",
            "NI": "Nickel",
            "RUTH": "Ruthenium",
            "UNI": "Uniswap",
            "XAG": "Silver",
            "XAU": "Gold",
            "XCU": "Copper",
            "XLM": "Stellar",
            "XPD": "Palladium",
            "XPT": "Platinum",
            "XRH": "Rhodium",
            "XRP": "Ripple",
            "ZNC": "Zinc",
        }

        let assetValues = {
            "ADA": 0.3,
            "ALU": 10,
            "AAPL": 2000,
            "ABEA": 1500,
            "AMZ": 500,
            "BCH": 1000,
            "BTC": 40000,
            "ETH": 6000,
            "IRD": 50,
            "LCO": 50,
            "LINK": 50,
            "LTC": 200,
            "FB2A": 800,
            "NI": 200,
            "RUTH": 200,
            "UNI": 50,
            "XAG": 25,
            "XAU": 1600,
            "XCU": 200,
            "XLM": 15,
            "XPD": 3000,
            "XPT": 5000,
            "XRH": 2000,
            "XRP": 0.8,
            "ZNC": 500,
        }

        const valuesAPIurl = 'https://commodities-api.com/api/latest';
        const valuesAPIkey = '?access_key=6oemg05g8508q5s2rrzn2aqjv4ig7ac7t4oz04u0bukj500tq02t6jmwhits';
        const valuesAPIbase = '&base=EUR';
        let valuesAPIsymbols = '&symbols='; //Add assetAbbs seperated with commas
        let valuesAPIlink;

        const valuesAPI2url = 'https://yfapi.net/v6/finance/quote';
        const valuesAPI2key = '?access_key=Z1EVIMF28V618X3D';
        const valuesAPI2base = '&base=EUR';
        let valuesAPI2symbols = '&symbols='; //Add assetAbbs seperated with commas
        let valuesAPI2link;
        let euroPerUsd = 1 / 1.08;

        // MXrzxkKCX04jatCdZBkaO6yYOJji3m4r2ZhUKd5e

        function updateAssetAbbs() {
            for (let singleAsset in ASSETS) {
                const thisAssetAbb = Object.keys(assetCodes).find(key => assetCodes[key] === ASSETS[singleAsset].assetName);
                ASSETS[singleAsset].assetAbb = thisAssetAbb;
            }
            updateLocalStorage();
        }

        async function updateAssetValues() {
            //generate API request
            for (let singleAsset in assetValues) {
                valuesAPIsymbols += singleAsset;
                valuesAPIsymbols += ',';
            }
            valuesAPIsymbols = valuesAPIsymbols.slice(0, -1);
            valuesAPIlink = valuesAPIurl + valuesAPIkey + valuesAPIbase + valuesAPIsymbols


            let assetValuesFromApi = {
                "ADA": 1.193330973679504,
                "ALU": 10.514131371630041,
                "BCH": 0.0033696857249744575,
                "BTC": 0.000027339894361282296,
                "ETH": 0.00036791100378043246,
                "IRD": 0.0002160703832587034,
                "LCO": 0.02921272565975125,
                "LINK": 0.08032822952760443,
                "LTC": 0.010056770315122874,
                "NI": 0.00003252599096522526,
                "RUTH": 0.0014403972198641973,
                "UNI": 0.11888624033728191,
                "XAG": 0.041357832033735754,
                "XAU": 0.0005424889761551438,
                "XCU": 3.573590625642131,
                "XLM": 5.520685882314111,
                "XPD": 0.0004573520381290784,
                "XPT": 0.001059369727054926,
                "XRP": 1.4430462888642641,
                "ZNC": 0.0002414652785689414
            };

            let assetValuesFromApi2 = {};

            // get assetValues from API1
            try {
                let response = await fetch(valuesAPIlink);
                assetValuesFromApi = await response.json();
                assetValuesFromApi = assetValuesFromApi.data.rates;
            } catch (e) {
                console.error(e);
                displayToast('Asset values could not be updated!')
            };


            for (let index in assetValues) {
                if (assetValuesFromApi[index] != null) {
                    assetValues[index] = (1 / assetValuesFromApi[index]).toFixed(2);
                    // console.log(index, [index]);
                } else {
                    console.log(index, 'not received from API - trying API2');

                    // get assetValues from API2
                    try {
                        let response = await fetch('https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=' + index + '&apikey=Z1EVIMF28V618X3D');
                        assetValueFromApi2 = await response.json();
                        assetValueFromApi2 = assetValueFromApi2["Global Quote"]["05. price"];
                        console.log(assetValueFromApi2 * euroPerUsd);
                        assetValues[index] = (assetValueFromApi2 * euroPerUsd)
                        console.log(assetValues[index]);
                    } catch (e) {
                        console.error(e);
                        displayToast('Asset values could not be updated!')
                    };


                }
            }

            console.log(assetValues);

            //Update assetBaseValue
            for (let singleAsset in ASSETS) {
                // const thisAssetBaseValue = Object.values(assetValues).find(value => assetValues[name] === ASSETS[singleAsset].assetAbb);
                const thisAssetAbb = ASSETS[singleAsset].assetAbb
                const thisAssetBaseValue = assetValues[thisAssetAbb]
                ASSETS[singleAsset].assetBaseValue = thisAssetBaseValue;
                // console.log('updated assetBaseValue');
            }

            //calculate assetValue (assetBaseValue * assetQuantity)
            for (let singleAsset in ASSETS) {
                ASSETS[singleAsset].assetValue = ASSETS[singleAsset].assetBaseValue * ASSETS[singleAsset].assetQuantity;
            }


            //Update local storage and browser
            calcTotalValue();
            updateLocalStorage();
            displayAssets();
            displayToast('Asset values updated.');
        }

        //SETUP
        window.addEventListener('load', function () {
            //Load ASSET from localstorage if available
            if (JSON.parse(localStorage.getItem("ASSETS")) !== null) {
                ASSETS = JSON.parse(localStorage.getItem("ASSETS"));
            }

            //get currentValues from API
            updateAssetAbbs();
            // updateAssetValues(); tmporarily disabled to spare API
            updateLocalStorage();
            calcTotalValue();
            displayAssets();
            console.log('assets updated');
        })

        function calcTotalValue() {
            //Calculate and display totalValue of Assets
            totalValue = 0
            for (let singleAsset in ASSETS) {
                totalValue = totalValue + ASSETS[singleAsset].assetValue
            }
            document.querySelector('#total-value').innerHTML = `Total Worth: ${totalValue.toLocaleString("de-DE")} €`;
        }

        //display assetForm
        function displayAssetForm(thisAssetType = '', thisAssetName = '', thisAssetQuantity = '', thisAssetNotes = '', isdirty = false) {
            console.log(isdirty);
            document.querySelector('#assetForm').innerHTML = `
            <form onsubmit="addAsset(this); return false;">
                <datalist id="assetTypeList">
                    <option value="Crypto">
                    <option value="Stocks">
                    <option value="Metals">
                </datalist>
                <datalist id="Metals">
                    <option value="Aluminum">
                    <option value="Cobalt">
                    <option value="Copper">
                    <option value="Gold">
                    <option value="Nickel">
                    <option value="Palladium">
                    <option value="Platinum">
                    <option value="Ruthenium">
                    <option value="Silver">  
                    <option value="Zinc">
                </datalist>
                <datalist id="Stocks">
                    <option value="Apple">
                    <option value="Meta">
                    <option value="Alphabet">
                    <option value="Amazon">
                </datalist>
                <datalist id="Crypto">
                    <option value="Bitcoin">
                    <option value="Bitcoin Cash">
                    <option value="Cardano">
                    <option value="ChainLink">
                    <option value="Ethereum">
                    <option value="Dogecoin">
                    <option value="Litecoin">
                    <option value="Ripple">
                    <option value="Solana">
                    <option value="Stellar">
                    <option value="Uniswap">
                </datalist>

                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label ${isdirty ? 'is-dirty' : ''}">
                    <input class="mdl-textfield__input" type="text" list="assetTypeList" id="assetTypeField" autocomplete="off" value="${thisAssetType}">
                    <label class="mdl-textfield__label" for="assetTypeField">Type</label>
                </div>
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label ${isdirty ? 'is-dirty' : ''}">
                    <input class="mdl-textfield__input" type="text" id="assetNameField" value="${thisAssetName}" autocomplete="off" onclick="setAssetType()"">
                    <label class="mdl-textfield__label" for="assetNameField">Asset</label>
                </div>
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label ${isdirty ? 'is-dirty' : ''}">
                    <input class="mdl-textfield__input" type="text" pattern="-?[0-9]*(\.[0-9]+)?"
                        id="assetQuantityField" autocomplete="off" value="${thisAssetQuantity}">
                    <label class="mdl-textfield__label" for="assetQuantityField"
                        id="assetQuantityLabel">Quantity</label>
                    <span class="mdl-textfield__error">Input is not a number!</span>
                    <span id="assetUnitField"></span>
                </div>
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label ${isdirty ? 'is-dirty' : ''}">
                    <input class="mdl-textfield__input" type="text" id="assetNotesField" autocomplete="off" value="${thisAssetNotes}">
                    <label class="mdl-textfield__label" for="assetNotesField">Notes</label>
                </div>
                <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent" type="submit">
                    Save
                </button>
            </form>
            <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored" onclick="hideAssetForm()">
                Cancel
            </button>
            `
        }

        //hide assetForm and clear input fields and error message
        function hideAssetForm() {
            document.querySelector('#assetForm').innerHTML = ''; //hide assetForm
            // assetTypeField.value = '';
            // assetNameField.value = '';
            // assetQuantityField.value = '';
            // assetNotesField.value = '';
        }

        //Prepare assetNameField dropdown and assetUnit in Form according to assetTypeField
        function setAssetType() {
            if (document.getElementById("assetTypeField").value === "") {
                displayToast('Chose asset type first!')
                return
            }
            const assetType = document.getElementById("assetTypeField").value
            switch (assetType) {
                case 'Stocks':
                    document.querySelector('#assetNameField').setAttribute("list", "Stocks")
                    document.querySelector('#assetQuantityLabel').innerHTML = 'Quantity (Pieces)'
                    break;
                case 'Metals':
                    document.querySelector('#assetNameField').setAttribute("list", "Metals")
                    document.querySelector('#assetQuantityLabel').innerHTML = 'Quantity (Oz)'
                    break;
                case 'Crypto':
                    document.querySelector('#assetNameField').setAttribute("list", "Crypto")
                    document.querySelector('#assetQuantityLabel').innerHTML = 'Quantity (Pieces)'
                    break;
            }
        }


        //Push form input to ASSETS
        function addAsset(form) {
            //Make sure form is filled completely
            if (form.assetTypeField.value === "") {
                displayToast('Enter asset type!')
                return
            }
            if (form.assetNameField.value === "") {
                displayToast('Enter asset name!')
                return
            }
            if (form.assetTypeField.value === "") {
                displayToast('Chose asset type!')
                return
            }
            if (form.assetQuantityField.value === "") {
                displayToast('Enter asset quantity!')
                return
            }

            //find assetUnit for assetType
            const thisAssetQuantityUnit = assetQuantityUnits.find(assetUnit => assetUnit.name == form.assetTypeField.value).unit;

            //find assetAbb for assetName


            //find assetBaseValue for assetName


            //calculate assetValue with assetBaseValue and assetQuantity




            //Push asset to ASSETS
            ASSETS[form.assetNameField.value] = { assetType: form.assetTypeField.value, assetName: form.assetNameField.value, assetAbb: "", assetQuantity: form.assetQuantityField.value, assetUnit: thisAssetQuantityUnit, assetValue: "", assetNotes: form.assetNotesField.value }
            displayToast('Asset saved successfully!')
            updateAssetAbbs()
            updateAssetValues()
            calcTotalValue();
            updateLocalStorage();
            hideAssetForm()
            displayAssets();
        }

        function deleteAsset(singleAsset, singleAssetName) {
            if (confirm('Sure, you want to delete Asset "' + singleAssetName + '"?') === false)     // alert('löschen...');
                return
            DELETED_ASSET = ASSETS[singleAsset];
            delete ASSETS[singleAsset]

            updateLocalStorage();
            calcTotalValue();
            displayAssets();
            // displayToast('Asset "' + singleAssetName + '" deleted.');
            displaySnackbar(('Asset "' + singleAssetName + '" deleted.'), 'undo', undoDeleteAsset);
        }

        function undoDeleteAsset() {
            ASSETS[DELETED_ASSET.value] = DELETED_ASSET
            // ASSETS.push(deletedAsset);
            updateLocalStorage();
            calcTotalValue();
            displayAssets();
            displayToast('Asset "' + DELETED_ASSET.assetName + '" restored successfully.')
        }

        function editAsset(singleAsset) {
            displayAssetForm(ASSETS[singleAsset].assetType, ASSETS[singleAsset].assetName, ASSETS[singleAsset].assetQuantity, ASSETS[singleAsset].assetNotes, true);

            // updateLocalStorage();
            // calcTotalValue();
            // hideAssetForm()
            // displayAssets();
        }

        function updateLocalStorage() {
            //update ASSETS in localstorage
            localStorage.setItem("ASSETS", JSON.stringify(ASSETS));
        }

        //Display Toast for wrong form inputs and other information
        function displayToast(error) {
            var notification = document.querySelector('.mdl-js-snackbar');
            notification.MaterialSnackbar.showSnackbar(
                {
                    message: error
                }
            );
        }

        //Display Snackbar for wrong form inputs and other information
        function displaySnackbar(error, buttonText, buttonFunction) {
            var notification = document.querySelector('.mdl-js-snackbar');
            var data = {
                message: error,
                actionHandler: function (event) { buttonFunction() },
                actionText: buttonText,
                timeout: 10000
            };
            notification.MaterialSnackbar.showSnackbar(data);
        }

        //Display Assets from ASSETS
        function displayAssets() {
            document.querySelector('#asset-list').innerHTML = '';
            for (let singleAsset in ASSETS) {
                // console.log(singleAsset, ASSETS[singleAsset])
                // console.log(ASSETS[singleAsset].assetType)

                document.querySelector('#asset-list').innerHTML += `
                <div class="demo-card-square mdl-card mdl-shadow--2dp ${ASSETS[singleAsset].assetType}">
                    <div class="mdl-card__title mdl-card--expand">
                        <h2 class="mdl-card__title-text">${ASSETS[singleAsset].assetName} (${ASSETS[singleAsset].assetAbb})</h2>
                    </div>
                    <div class="mdl-card__supporting-text">
                        ${ASSETS[singleAsset].assetQuantity} ${ASSETS[singleAsset].assetUnit}<br>
                        Value: ${ASSETS[singleAsset].assetValue.toLocaleString("de-DE")}€<br>
                        Notes: ${ASSETS[singleAsset].assetNotes}
                    </div>
                    <div class="mdl-card__actions mdl-card--border">
                        <a class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect" onclick="editAsset('${singleAsset}', '${ASSETS[singleAsset].assetName}')">
                            edit
                        </a>
                        <a class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect" onclick="deleteAsset('${singleAsset}', '${ASSETS[singleAsset].assetName}')">
                            delete
                        </a>
                    </div>
                </div>
                `;

            }
        }

    </script>
</head>

<body>
    <div id="wrapper">
        <h1>Track yo assets!</h1>

        <div id="assetForm" class="layoutElement">
        </div>

        <div id="assetControls" class="layoutElement">
            <!-- Colored raised button -->
            <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored"
                onclick="displayAssetForm()">
                Add Asset
            </button>
            <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored"
                onclick="updateAssetValues()">
                Update Values
            </button>
            <!-- <div id="assetFilters">
                <span class="mdl-chip mdl-chip--deletable">
                    <span class="mdl-chip__text">Crypto</span>
                    <button type="button" class="mdl-chip__action"><i class="material-icons">cancel</i></button>
                </span>
                <span class="mdl-chip mdl-chip--deletable">
                    <span class="mdl-chip__text">Metal</span>
                    <button type="button" class="mdl-chip__action"><i class="material-icons">cancel</i></button>
                </span>
                <span class="mdl-chip mdl-chip--deletable">
                    <span class="mdl-chip__text">Stocks</span>
                    <button type="button" class="mdl-chip__action"><i class="material-icons">cancel</i></button>
                </span>
            </div> -->
        </div>

        <div id="asset-list" class="layoutElement">
            <!-- <div class="demo-card-square mdl-card mdl-shadow--2dp Crypto">
                <div class="mdl-card__title mdl-card--expand">
                    <h2 class="mdl-card__title-text">Bitcoin (BTC)</h2>
                </div>
                <div class="mdl-card__supporting-text">
                    1 Coin <br>
                    Value: 1000,00€
                </div>
                <div class="mdl-card__actions mdl-card--border">
                    <a class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect">
                        edit
                    </a>
                    <a class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect">
                        delete
                    </a>
                </div>
            </div>

            <div class="demo-card-square mdl-card mdl-shadow--2dp Stocks">
                <div class="mdl-card__title mdl-card--expand">
                    <h2 class="mdl-card__title-text">Apple (AAPL)</h2>
                </div>
                <div class="mdl-card__supporting-text">
                    1 Stock <br>
                    Value: 1000,00€
                </div>
                <div class="mdl-card__actions mdl-card--border">
                    <a class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect">
                        edit
                    </a>
                    <a class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect">
                        delete
                    </a>
                </div>
            </div>

            <div class="demo-card-square mdl-card mdl-shadow--2dp Metals">
                <div class="mdl-card__title mdl-card--expand">
                    <h2 class="mdl-card__title-text">Gold</h2>
                </div>
                <div class="mdl-card__supporting-text">
                    1 Ounce <br>
                    1000,00€
                </div>
                <div class="mdl-card__actions mdl-card--border">
                    <a class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect">
                        edit
                    </a>
                    <a class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect">
                        delete
                    </a>
                </div>
            </div> -->
        </div>
        <br clear="all">
        <div id="footer">
            <p id="total-value" class="layoutElement"></p>
            <br>
            <p class="layoutElement">This tools does...</p>
        </div>
        <div aria-live="assertive" aria-atomic="true" aria-relevant="text" class="mdl-snackbar mdl-js-snackbar">
            <div class="mdl-snackbar__text"></div>
            <button type="button" class="mdl-snackbar__action"></button>
        </div>
    </div>
</body>

</html>